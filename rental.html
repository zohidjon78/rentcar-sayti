<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ijaraga olish - RentCar Premium</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    
    <style>
    :root {
        --primary: #004aad;
        --success: #2ecc71;
        --warning: #f39c12;
        --danger: #e74c3c;
        --dark: #2c3e50;
    }

    body {
        font-family: 'Poppins', sans-serif;
        background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        min-height: 100vh;
        margin: 0;
        padding: 15px; /* Mobilda biroz kamaytirildi */
    }

    .rental-container {
        width: 100%; /* Kenglik foizda berildi */
        max-width: 700px;
        margin: 20px auto; /* Mobilda yuqoridagi masofa kamaytirildi */
        background: #fff;
        padding: 30px; /* Planshet va mobil uchun moslashtirildi */
        border-radius: 24px;
        box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
        box-sizing: border-box;
    }

    h1 { 
        color: var(--primary); 
        font-weight: 700; 
        text-align: center; 
        margin-bottom: 5px; 
        font-size: clamp(1.5rem, 6vw, 2rem); /* Sarlavha o'lchami moslashuvchan */
    }

    .car-display { 
        background: #f8f9fa; 
        padding: 15px; 
        border-radius: 12px; 
        text-align: center; 
        margin-bottom: 30px;
        border-left: 5px solid var(--primary);
    }

    .form-group { margin-bottom: 20px; }
    label { display: block; font-weight: 600; color: var(--dark); margin-bottom: 8px; font-size: 0.9rem; }
    
    input, select {
        width: 100%;
        padding: 12px 15px;
        border: 2px solid #edf2f7;
        border-radius: 10px;
        font-size: 16px; /* iPhone zoom bo'lmasligi uchun 16px */
        transition: 0.3s;
        box-sizing: border-box;
    }

    input:focus { border-color: var(--primary); outline: none; box-shadow: 0 0 0 4px rgba(0, 74, 173, 0.1); }

    .face-id-wrapper {
        text-align: center;
        padding: 20px;
        background: #fcfcfc;
        border: 2px dashed #cbd5e0;
        border-radius: 15px;
    }

    #webcam-preview {
        /* Kichik ekranlarda video sig'ishi uchun max-width qo'shildi */
        width: 100%; 
        max-width: 220px;
        aspect-ratio: 1/1; /* Doira shakli buzilmasligi uchun */
        height: auto;
        border-radius: 50%;
        object-fit: cover;
        border: 5px solid var(--primary);
        margin: 0 auto 15px;
        display: none;
        transform: scaleX(-1); 
    }

    .pulse-animation {
        animation: pulse 2s infinite;
    }

    @keyframes pulse {
        0% { box-shadow: 0 0 0 0 rgba(46, 204, 113, 0.4); }
        70% { box-shadow: 0 0 0 20px rgba(46, 204, 113, 0); }
        100% { box-shadow: 0 0 0 0 rgba(46, 204, 113, 0); }
    }

    .btn-main {
        width: 100%;
        padding: 15px;
        border: none;
        border-radius: 12px;
        font-weight: 700;
        font-size: 1rem;
        cursor: pointer;
        transition: 0.3s;
        -webkit-tap-highlight-color: transparent; /* Mobil bosish effekti */
    }

    .btn-primary { background: var(--primary); color: white; }
    .btn-primary:hover { background: #003580; transform: translateY(-2px); }
    
    .btn-outline {
        background: transparent;
        border: 2px solid var(--warning);
        color: var(--warning);
        font-size: 0.9rem;
        padding: 10px;
        margin-top: 10px; /* Tugmalar orasidagi masofa */
    }

    .security-note {
        font-size: 0.8rem;
        color: #718096;
        display: flex;
        align-items: center;
        justify-content: center; /* Mobilda markazda turishi uchun */
        gap: 10px;
        margin-top: 15px;
        text-align: center;
    }

    .preview-img {
        width: 100px;
        height: 60px;
        object-fit: cover;
        margin-top: 10px;
        border-radius: 5px;
        display: none;
    }

    .back-link {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        text-decoration: none;
        color: var(--dark);
        font-weight: 600;
        font-size: 0.85rem;
        margin-bottom: 15px;
        transition: 0.3s;
        padding: 8px 15px;
        border-radius: 10px;
        background: #f0f2f5;
    }

    /* MEDIA QUERIES - ASOSIY MOSLASHUVCHANLIK */
    @media (max-width: 600px) {
        body {
            padding: 10px;
        }
        .rental-container {
            padding: 20px;
            margin: 10px auto;
            border-radius: 15px;
        }
        .car-display {
            font-size: 0.9rem;
            padding: 10px;
        }
        .btn-main {
            padding: 12px;
            font-size: 0.95rem;
        }
    }

    /* Planshetlar uchun */
    @media (min-width: 601px) and (max-width: 1024px) {
        .rental-container {
            max-width: 90%;
            padding: 30px;
        }
    }
</style>
</head>
<body>

<div class="rental-container">
    <a href="javascript:history.back()" class="back-link">
        <i class="fas fa-arrow-left"></i> Orqaga qaytish
    </a>
    <h1><i class="fas fa-car-side"></i> Ijarani Rasmiylashtirish</h1>
    <div class="car-display">
        <h2 style="margin:0; font-size: 1.3rem;">Mashina: <span id="selected-car-name" style="color: var(--primary);">---</span></h2>
    </div>

    <form id="rentalForm">
        <div class="form-group">
            <label><i class="fas fa-user"></i> To'liq ismingiz</label>
            <input type="text" name="full_name" placeholder="Ismingizni kiriting" required>
        </div>

        <div class="form-group">
            <label><i class="fas fa-phone"></i> Telefon raqamingiz</label>
            <div style="display: flex; gap: 10px;">
                <input type="tel" id="phone" value="+998" placeholder="+998 -- --- -- --" required>
                <button type="button" id="send-otp-btn" class="btn-main btn-outline" style="flex: 0 0 160px;" onclick="sendOTP()">Kod yuborish</button>
            </div>
        </div>

        <div id="otp-area" style="display: none;" class="form-group">
            <label>Tasdiqlash kodi</label>
            <div style="display: flex; gap: 10px;">
                <input type="text" id="otp_code" placeholder="4 xonali kod" maxlength="4">
                <button type="button" class="btn-main btn-primary" style="flex: 0 0 120px; padding: 10px;" onclick="verifyOTP()">Tasdiqlash</button>
            </div>
            <small id="otp-timer" style="color: var(--warning);"></small>
        </div>

        <div style="display: flex; gap: 15px;">
            <div class="form-group" style="flex: 1;">
                <label><i class="fas fa-calendar-plus"></i> Olish sanasi</label>
                <input type="date" id="start_date" required>
            </div>
            <div class="form-group" style="flex: 1;">
                <label><i class="fas fa-calendar-minus"></i> Topshirish sanasi</label>
                <input type="date" id="end_date" required disabled>
            </div>
        </div>

        <div class="form-group">
            <label><i class="fas fa-file-upload"></i> Haydovchilik guvohnomasi & Pasport</label>
            <input type="file" accept="image/*" onchange="previewFile(this, 'preview1')" required>
            <img id="preview1" class="preview-img">
            
            <input type="file" style="margin-top:10px" accept="image/*" onchange="previewFile(this, 'preview2')" required>
            <img id="preview2" class="preview-img">
        </div>

        <div class="face-id-wrapper">
            <label style="text-align: center;"><i class="fas fa-fingerprint"></i> Biometrik tasdiqlash (Face ID)</label>
            <video id="webcam-preview" autoplay playsinline></video>
            <div id="verify-status" style="margin-bottom: 10px; font-weight: bold; color: var(--danger);">Tasdiqlanmagan</div>
            <button type="button" id="face-btn" class="btn-main btn-outline" onclick="handleFaceID()">
                <i class="fas fa-camera"></i> Kamerani yoqish
            </button>
        </div>

        <div class="security-note">
            <input type="checkbox" id="agree" style="width: 20px; height: 20px;" required>
            <label for="agree" style="margin:0; font-weight: 400;">
                Men ijara shartlari va <b style="color: var(--danger);">to'liq javobgarlikni</b> zimmamga olishga roziman.
            </label>
        </div>

        <div style="margin-top: 30px;">
            <button type="submit" class="btn-main btn-primary">
                <i class="fas fa-credit-card"></i> To'lovga o'tish
            </button>
        </div>
    </form>
</div>

<script>
    const car = new URLSearchParams(window.location.search).get('car') || "Tanlanmagan";
    document.getElementById('selected-car-name').innerText = car;

    // --- SANALAR UCHUN TUZATISH ---
    const startDateInput = document.getElementById('start_date');
    const endDateInput = document.getElementById('end_date');
    const today = new Date().toISOString().split('T')[0];

    startDateInput.min = today; // Olish sanasi eng kamida bugun bo'lishi kerak

    startDateInput.addEventListener('change', function() {
        if (this.value) {
            endDateInput.disabled = false; // Olish sanasi tanlangandan keyin topshirishni ochamiz
            endDateInput.min = this.value; // Topshirish sanasi olish sanasidan kichik bo'lolmaydi
            
            // Agar oldin tanlangan topshirish sanasi yangi olish sanasidan kichik bo'lib qolsa, uni tozalaymiz
            if (endDateInput.value && endDateInput.value < this.value) {
                endDateInput.value = "";
            }
        } else {
            endDateInput.disabled = true;
        }
    });

    function previewFile(input, imgId) {
        const preview = document.getElementById(imgId);
        const file = input.files[0];
        const reader = new FileReader();
        reader.onloadend = () => { preview.src = reader.result; preview.style.display = 'block'; }
        if (file) reader.readAsDataURL(file);
    }

    let verifiedPhone = false;
    function sendOTP() {
        const phone = document.getElementById('phone').value;
        if(phone.length < 13) return alert("Raqamni to'liq kiriting!");
        document.getElementById('otp-area').style.display = 'block';
        alert("Tasdiqlash kodi: 2107");
    }

    function verifyOTP() {
        if(document.getElementById('otp_code').value === '2107') {
            verifiedPhone = true;
            document.getElementById('otp-area').innerHTML = "<b style='color:green'>âœ… Telefon tasdiqlandi</b>";
        } else {
            alert("Kod noto'g'ri!");
        }
    }

    let stream = null;
    let faceVerified = false;

    async function handleFaceID() {
        const video = document.getElementById('webcam-preview');
        const btn = document.getElementById('face-btn');
        const status = document.getElementById('verify-status');

        if (!stream) {
            try {
                stream = await navigator.mediaDevices.getUserMedia({ video: true });
                video.srcObject = stream;
                video.style.display = 'block';
                btn.innerHTML = "Skanerlash...";
                status.innerText = "Yuzingizni markazda tuting";
                status.style.color = "orange";

                setTimeout(() => {
                    faceVerified = true;
                    video.classList.add('pulse-animation');
                    status.innerText = "âœ… Shaxs tasdiqlandi!";
                    status.style.color = "var(--success)";
                    btn.style.display = "none";
                }, 3000);

            } catch (err) {
                alert("Kameraga ruxsat berilmadi!");
            }
        }
    }

    document.getElementById('rentalForm').onsubmit = (e) => {
        e.preventDefault();
        if(!verifiedPhone) return alert("Iltimos, telefon raqamingizni tasdiqlang!");
        if(!faceVerified) return alert("Face ID tasdiqlanishi shart!");
        
        window.location.href = `payment.html?car=${car}&status=ready`;
    };

    window.onload = function() {
        const user = localStorage.getItem('userName');
        const loginLink = document.querySelector('a[href="login.html"]');

        if (user && loginLink) {
            loginLink.innerHTML = `ðŸ‘¤ ${user}`;
            loginLink.href = "profile.html";
            loginLink.style.fontWeight = "bold";
            loginLink.style.color = "#004aad";

            const logoutBtn = document.createElement('a');
            logoutBtn.innerHTML = " <i class='fas fa-sign-out-alt'></i>";
            logoutBtn.href = "#";
            logoutBtn.style.marginLeft = "10px";
            logoutBtn.style.color = "red";
            logoutBtn.onclick = function() {
                localStorage.removeItem('userName');
                window.location.reload();
            };
            loginLink.parentNode.appendChild(logoutBtn);
        }
    };
</script>

</body>
</html>